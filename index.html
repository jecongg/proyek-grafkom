<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Ruangan dengan Cahaya</title>
        <style>
            body {
                margin: 0;
            }
        </style>
    </head>
    <body>
        <script type="module">
            import * as THREE from "three";
            import { OrbitControls } from "three/addons/controls/OrbitControls.js";
            import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
            let yCamera = 2;

            // Scene
            const scene = new THREE.Scene();

            // Camera
            const camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, yCamera, 0);

            let prevZ = camera.position.z; // untuk deteksi arah

            // Renderer
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Ruangan (kubus besar tanpa bagian atas)
            const roomSize = 2;
            const roomGeometry = new THREE.BoxGeometry(
                roomSize,
                roomSize,
                roomSize
            );
            const roomMaterial = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                side: THREE.BackSide,
            });
            const room = new THREE.Mesh(roomGeometry, roomMaterial);
            room.position.set(10, 0, 0);
            scene.add(room);

            // ðŸŒŸ Cahaya dalam Ruangan ðŸŒŸ
            // Ambient Light (Cahaya menyebar)
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(ambientLight);

            // SpotLight (Lampu sorot dari atas)
            const spotLight = new THREE.SpotLight(0xffffff, 0.8);
            spotLight.position.set(3, 4, 3);
            spotLight.angle = Math.PI / 6;
            spotLight.penumbra = 0.3;
            spotLight.castShadow = true;
            scene.add(spotLight);

            // Point Light (Lampu kecil di tengah ruangan)
            const pointLight = new THREE.PointLight(0xffaa00, 1.2, 5);
            pointLight.position.set(0, 1.5, 0);
            scene.add(pointLight);

            // Directional Light (Cahaya seperti matahari dari satu sisi)
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(1, 2, -1);
            scene.add(directionalLight);

            // Material warna-warni
            const materials = [
                new THREE.MeshStandardMaterial({ color: 0xff5733 }), // Merah
                new THREE.MeshStandardMaterial({ color: 0x33ff57 }), // Hijau
                new THREE.MeshStandardMaterial({ color: 0x3357ff }), // Biru
                new THREE.MeshStandardMaterial({ color: 0xffff33 }), // Kuning
                new THREE.MeshStandardMaterial({ color: 0xff33ff }), // Ungu
            ];

            // 1. Bola
            const sphere = new THREE.Mesh(
                new THREE.SphereGeometry(0.6, 32, 32),
                materials[0]
            );
            sphere.position.set(-2, -2 + 0.6, 0);
            scene.add(sphere);

            // 2. Torus
            const torus = new THREE.Mesh(
                new THREE.TorusGeometry(0.6, 0.2, 16, 100),
                materials[1]
            );
            torus.position.set(2, -2 + 0.6, 0);
            scene.add(torus);

            // 3. Kerucut
            const cone = new THREE.Mesh(
                new THREE.ConeGeometry(0.6, 1.2, 32),
                materials[2]
            );
            cone.position.set(0, -2 + 0.6, -2);
            scene.add(cone);

            // 4. Silinder
            const cylinder = new THREE.Mesh(
                new THREE.CylinderGeometry(0.5, 0.5, 1.2, 32),
                materials[3]
            );
            cylinder.position.set(-1.5, -2 + 0.6, 2);
            scene.add(cylinder);

            // 5. Dodecahedron
            const dodecahedron = new THREE.Mesh(
                new THREE.DodecahedronGeometry(0.7),
                materials[4]
            );
            dodecahedron.position.set(1.5, -2 + 0.7, 2);
            scene.add(dodecahedron);
            const loader = new GLTFLoader();

            let basement;
            loader.load(
                "./assets/models/room/rock_wall_basement_with_baked_lighting.glb",
                function (gltf) {
                    basement = gltf.scene;
                    basement.scale.set(1, 1, 1);
                    basement.position.set(0, 0, 0);
                    scene.add(gltf.scene);
                }
            );

            const movement = {
                forward: false,
                backward: false,
                left: false,
                right: false,
            };

            const speed = 0.05;
            const velocity = new THREE.Vector3();

            // Event Listener Keyboard
            document.addEventListener("keydown", (e) => {
                switch (e.code) {
                    case "KeyW":
                        movement.forward = true;
                        break;
                    case "KeyS":
                        movement.backward = true;
                        break;
                    case "KeyA":
                        movement.left = true;
                        break;
                    case "KeyD":
                        movement.right = true;
                        break;
                }
            });
            document.addEventListener("keyup", (e) => {
                switch (e.code) {
                    case "KeyW":
                        movement.forward = false;
                        break;
                    case "KeyS":
                        movement.backward = false;
                        break;
                    case "KeyA":
                        movement.left = false;
                        break;
                    case "KeyD":
                        movement.right = false;
                        break;
                }
            });

            // Mouse kontrol untuk rotasi kamera
            let yaw = 0;
            let pitch = 0;
            let isMouseDown = false;

            document.addEventListener("mousedown", () => {
                isMouseDown = true;
            });
            document.addEventListener("mouseup", () => {
                isMouseDown = false;
            });

            document.addEventListener("mousemove", (event) => {
                if (!isMouseDown) return;
                yaw -= event.movementX * 0.002;
                pitch -= event.movementY * 0.002;
                pitch = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, pitch));
            });

            // Update posisi kamera
            function updateCameraMovement() {
                velocity.set(0, 0, 0);

                const direction = new THREE.Vector3();
                const frontVector = new THREE.Vector3(
                    Math.sin(yaw),
                    0,
                    Math.cos(yaw)
                );
                const sideVector = new THREE.Vector3(
                    Math.sin(yaw - Math.PI / 2),
                    0,
                    Math.cos(yaw - Math.PI / 2)
                );

                if (movement.forward) velocity.add(frontVector);
                if (movement.backward) velocity.sub(frontVector);
                if (movement.left) velocity.sub(sideVector); // diperbaiki
                if (movement.right) velocity.add(sideVector); // diperbaiki

                // Tangga di antara z: -5.5 (atas) hingga -4 (bawah), dan x: -1 sampai 1
                const onStair =
                    camera.position.z < -4 &&
                    camera.position.z > -5.5 &&
                    camera.position.x > -2 &&
                    camera.position.x < 0.8;

                const afterStairTop =
                    camera.position.z <= -5.5 &&
                    camera.position.x > -1 &&
                    camera.position.x < 1;
                const beforeStairBottom = camera.position.z >= -4.0;

                // Deteksi arah
                const dz = camera.position.z - prevZ;

                if (onStair) {
                    if (dz < 0) {
                        // Naik
                        camera.position.y += 0.03;
                        camera.position.y = Math.min(camera.position.y, 4);
                    } else if (dz > 0) {
                        // Turun
                        camera.position.y -= 0.03;
                        camera.position.y = Math.max(camera.position.y, 2);
                    } else if (afterStairTop) {
                        // Smooth naik ke y=4
                        camera.position.y += (4 - camera.position.y) * 0.1;
                    } else if (beforeStairBottom) {
                        // Smooth turun ke y=2
                        camera.position.y += (2 - camera.position.y) * 0.1;
                    }
                }

                prevZ = camera.position.z;

                velocity.normalize().multiplyScalar(speed);

                camera.position.add(velocity);

                camera.lookAt(
                    camera.position.x + Math.sin(yaw),
                    camera.position.y + Math.sin(pitch),
                    camera.position.z + Math.cos(yaw)
                );
                console.log(camera.position);
            }

            // Animasi (ganti `animate()` sebelumnya)
            function animate() {
                requestAnimationFrame(animate);

                updateCameraMovement();

                // Rotasi objek
                sphere.rotation.y += 0.01;
                torus.rotation.x += 0.02;
                cone.rotation.y += 0.015;
                cylinder.rotation.z += 0.02;
                dodecahedron.rotation.x += 0.01;
                dodecahedron.rotation.y += 0.01;

                renderer.render(scene, camera);

                // console.log('Rendering frame...');
            }
            animate();
        </script>
    </body>
</html>
